<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quickly Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Canvas */
        #canvasContainer {
            width: 100%;
            /* ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Aspect Ratio (Padding Top) 3:2 = (2/3) * 100% = 66.6667% */
            padding-top: 66.6667%; 
            position: relative;
        }

        #imageCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #3b82f6; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
            background-color: transparent; 
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
            /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cursor ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Crosshair ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û */
            cursor: crosshair; 
        }

        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .mode-btn.active {
            box-shadow: 0 0 0 3px #3b82f6;
            transform: scale(0.98);
        }

        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Loading Indicator */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">
            ‚ö° Quickly Report
        </h1>

        <div class="mb-8 p-4 border-b-2 border-blue-100 space-y-4">
            
            <div class="space-y-4 pb-4 border-b border-gray-100">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0 pt-4">
                    <label for="fileInput" class="text-lg font-medium text-gray-700 whitespace-nowrap">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:
                    </label>
                    <input type="file" id="fileInput" accept="image/*" multiple class="block w-full sm:w-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 pt-4">
                    <div class="flex flex-col space-y-1">
                        <label for="employeeFileInput1" class="text-lg font-medium text-gray-700 whitespace-nowrap">‡∏û‡∏ô‡∏á.1 :</label>
                        <input type="file" id="employeeFileInput1" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label for="employeeFileInput2" class="text-lg font-medium text-gray-700 whitespace-nowrap">‡∏û‡∏ô‡∏á.2 :</label>
                        <input type="file" id="employeeFileInput2" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label for="employeeFileInput3" class="text-lg font-medium text-gray-700 whitespace-nowrap">‡∏û‡∏ô‡∏á.3 :</label>
                        <input type="file" id="employeeFileInput3" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label for="employeeFileInput4" class="text-lg font-medium text-gray-700 whitespace-nowrap">‡∏û‡∏ô‡∏á.4 :</label>
                        <input type="file" id="employeeFileInput4" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label for="employeeFileInput5" class="text-lg font-medium text-gray-700 whitespace-nowrap">‡∏û‡∏ô‡∏á.5 :</label>
                        <input type="file" id="employeeFileInput5" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="space-y-4 sm:space-y-0 sm:grid sm:grid-cols-2 md:grid-cols-4 sm:gap-4 pt-4">
                <div class="flex flex-col space-y-1">
                    <span class="text-sm font-medium text-gray-700">Area :</span>
                    <input type="text" id="areaInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full transition duration-150 text-gray-800"/>
                </div>
                <div class="flex flex-col space-y-1">
                    <span class="text-sm font-medium text-gray-700">Title job :</span>
                    <input type="text" id="titleJopInput" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full transition duration-150 text-gray-800"/>
                </div>
                <div class="flex flex-col space-y-1">
                    <span class="text-sm font-medium text-gray-700">SAP No. :</span>
                    <input type="text" id="sapNoInput" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç SAP" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full transition duration-150 text-gray-800"/>
                </div>
                <div class="flex flex-col space-y-1">
                    <span class="text-sm font-medium text-gray-700">Date :</span>
                    <input type="date" id="dateInput" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full transition duration-150 text-gray-800"/>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center">
            <p id="statusMessage" class="text-red-500 mb-4 hidden">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
            <div id="canvasContainer" class="w-full">
                <canvas id="imageCanvas"></canvas>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ß‡∏≤‡∏î‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ö‡∏ô Canvas</p>
        </div>
        
        <div class="flex flex-col gap-4 p-4 border-t border-gray-100 mt-8"> 
            
            <input type="text" id="textDrawingInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡∏†‡∏≤‡∏û... (‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô Canvas ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á)" 
                   class="p-4 border border-gray-400 rounded-lg shadow-md focus:ring-blue-500 focus:border-blue-500 w-full text-gray-800 hidden text-base" />

            <div class="flex flex-col gap-4">
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                    <button id="modeRect" class="mode-btn px-4 py-3 rounded-xl font-bold text-base transition duration-150 bg-red-500 text-white hover:bg-red-600 active">‚¨õ ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</button>
                    <button id="modeCircle" class="mode-btn px-4 py-3 rounded-xl font-bold text-base transition duration-150 bg-red-500 text-white hover:bg-red-600">üî¥ ‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
                    <button id="modeArrow" class="mode-btn px-4 py-3 rounded-xl font-bold text-base transition duration-150 bg-red-500 text-white hover:bg-red-600">‚û°Ô∏è ‡∏•‡∏π‡∏Å‡∏®‡∏£</button>
                    
                    <button id="modeText" class="mode-btn px-4 py-3 rounded-xl font-bold text-base transition duration-150 bg-green-500 text-white hover:bg-green-600">‚úèÔ∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                    
                    <button id="btnUndo" class="px-4 py-3 rounded-xl font-bold text-base transition duration-150 bg-amber-500 text-white hover:bg-amber-600">‚Ü©Ô∏è Undo</button>

                    <button id="modeClear" class="px-4 py-3 rounded-xl font-bold text-base transition duration-150 bg-gray-200 text-gray-800 hover:bg-gray-300" onclick="clearShapes()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ß‡∏≤‡∏î</button>
                </div>

                <button 
                    id="saveButton" 
                    class="px-6 py-3 rounded-xl font-bold text-lg transition duration-150 bg-blue-600 text-white hover:bg-blue-700 shadow-xl hover:shadow-2xl w-full disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="saveButtonContent" class="flex items-center justify-center gap-2">
                        üíæ Save Report (PNG)
                    </span>
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // ‡πÉ‡∏ä‡πâ DOMContentLoaded ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ Elements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà script ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        document.addEventListener('DOMContentLoaded', () => {
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Canvas
            const PADDING_FACTOR = 1; 
            const ASPECT_RATIO = 2 / 3; 
            const BACKGROUND_COLOR = '#ffffff'; // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            const DRAW_COLOR = '#ff0000'; 
            const DRAW_LINE_WIDTH_FACTOR = 4; 
            // EXPORT_SCALE_FACTOR (2.5) ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° 2.5 ‡πÄ‡∏ó‡πà‡∏≤
            const EXPORT_SCALE_FACTOR = 2.5; 
            const HEADER_FONT_SIZE_TITLE = 20; // Operations report - 20px
            const HEADER_FONT_SIZE_OTHER = 16; // Area, Title job, SAP No., Date - 16px
            const EXTERNAL_H_PADDING_FACTOR = 15;
            const FONT_EXPORT_BOOST_FACTOR = 1.5; 
            const TEXT_DRAWING_FONT_SIZE = 18;

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á PTT ‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            const PTT_BACKGROUND_IMAGE_PATH = 'pttp.png'; 
            const EMPLOYEE_DISPLAY_WIDTH_CM = 2; // 2cm
            const EMPLOYEE_DISPLAY_HEIGHT_CM = 3; // 3cm
            const DPI = 96; // Standard DPI for screen
            // ‡πÅ‡∏õ‡∏•‡∏á cm ‡πÄ‡∏õ‡πá‡∏ô px ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô Canvas
            // PADDING_FACTOR ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏ô redrawContent ‡πÅ‡∏•‡∏∞ exportHighResolution
            const EMPLOYEE_DISPLAY_WIDTH_PX = EMPLOYEE_DISPLAY_WIDTH_CM * DPI / 2.54; 
            const EMPLOYEE_DISPLAY_HEIGHT_PX = EMPLOYEE_DISPLAY_HEIGHT_CM * DPI / 2.54; 

            
            // Elements
            const fileInput = document.getElementById('fileInput');
            // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á input files ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 5 ‡∏Ñ‡∏ô
            const employeeFileInputs = [
                document.getElementById('employeeFileInput1'),
                document.getElementById('employeeFileInput2'),
                document.getElementById('employeeFileInput3'),
                document.getElementById('employeeFileInput4'),
                document.getElementById('employeeFileInput5')
            ];

            const areaInput = document.getElementById('areaInput'); 
            const titleJopInput = document.getElementById('titleJopInput'); 
            const sapNoInput = document.getElementById('sapNoInput'); 
            const dateInput = document.getElementById('dateInput');
            const textDrawingInput = document.getElementById('textDrawingInput'); 
            const saveButton = document.getElementById('saveButton'); 
            const btnUndo = document.getElementById('btnUndo'); 
            const saveButtonContent = document.getElementById('saveButtonContent'); 
            const canvasContainer = document.getElementById('canvasContainer');
            const canvas = document.getElementById('imageCanvas');
            const ctx = canvas.getContext('2d'); 
            const statusMessage = document.getElementById('statusMessage');

            // Mode Buttons
            const modeRect = document.getElementById('modeRect');
            const modeCircle = document.getElementById('modeCircle');
            const modeArrow = document.getElementById('modeArrow');
            const modeText = document.getElementById('modeText');

            // State Management
            let loadedImages = []; // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å (Foreground) ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å fileInput
            let currentBackgroundImage = null; // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á PTT
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô loadedEmployeeImages ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î 5 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
            let loadedEmployeeImages = new Array(5).fill(null); 
            let drawingMode = 'RECT'; 
            let shapes = []; 
            let isDrawing = false;
            let startX = 0;
            let startY = 0;
            let currentShape = null;

            /**
             * Utility: Get Mouse/Touch Position relative to Canvas
             */
            function getCanvasPosition(event) {
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;

                if (event.touches) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }

                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }

            /**
             * Utility: Draw Arrowhead (Simplified) - Requires targetCtx for flexibility
             */
            function drawArrowhead(targetCtx, fromX, fromY, toX, toY) {
                const headlen = 8 * PADDING_FACTOR; 
                const angle = Math.atan2(toY - fromY, toX - fromX);
                
                targetCtx.beginPath();
                targetCtx.moveTo(toX, toY);
                targetCtx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
                targetCtx.moveTo(toX, toY);
                targetCtx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
                targetCtx.stroke();
            }

            /**
             * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û PTT)
             */
            function drawBackground(targetCtx, W, H) {
                targetCtx.fillStyle = BACKGROUND_COLOR; 
                targetCtx.fillRect(0, 0, W, H);

                if (currentBackgroundImage) {
                    console.log('Drawing pttp.png on canvas.'); 
                    targetCtx.drawImage(currentBackgroundImage, 0, 0, W, H);
                } else {
                    console.log('currentBackgroundImage is null, not drawing pttp.png.'); 
                }
            }
            
            /**
             * ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å YYYY-MM-DD ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
             */
            function formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                const parts = dateStr.split('-');
                if (parts.length === 3 && !isNaN(parseInt(parts[0]))) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`; 
                }
                return dateStr;
            }


            /**
             * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Header ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤
             */
            function drawHeaderText(targetCtx, W, H) {
                const area = areaInput.value || 'N/A';
                const titleJop = titleJopInput.value || 'N/A';
                const sapNo = sapNoInput.value || 'N/A';
                const dateValue = formatDate(dateInput.value); 

                const PADDING = 10 * PADDING_FACTOR;
                const FONT_BOOST = PADDING_FACTOR > 1 ? FONT_EXPORT_BOOST_FACTOR : 1; 

                const FONT_SIZE_TITLE_PX = HEADER_FONT_SIZE_TITLE * PADDING_FACTOR * FONT_BOOST;
                const FONT_SIZE_OTHER_PX = HEADER_FONT_SIZE_OTHER * PADDING_FACTOR * FONT_BOOST; 
                
                const LINE_HEIGHT_TITLE = FONT_SIZE_TITLE_PX * 1.1; 
                const LINE_HEIGHT_OTHER = FONT_SIZE_OTHER_PX * 1.5; 
                
                const topPadding = PADDING;
                const leftPadding = PADDING; 
                const rightPadding = PADDING; 
                
                targetCtx.textBaseline = 'top'; 
                targetCtx.fillStyle = '#1f2937'; 
                targetCtx.shadowColor = 'rgba(255, 255, 255, 0.7)'; 
                targetCtx.shadowBlur = 4 * PADDING_FACTOR;
                targetCtx.shadowOffsetX = 1 * PADDING_FACTOR;
                targetCtx.shadowOffsetY = 1 * PADDING_FACTOR;

                let currentY = topPadding;
                
                // --- 1. Operations Report (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ - BIG FONT) ---
                targetCtx.font = `bold ${FONT_SIZE_TITLE_PX}px Inter, sans-serif`;
                targetCtx.textAlign = 'right'; 
                targetCtx.fillText('Operations report', W - rightPadding, currentY); 
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Y ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
                const numActiveEmployees = loadedEmployeeImages.filter(img => img !== null).length;
                const employeeBlockHeight = numActiveEmployees > 0 ? (EMPLOYEE_DISPLAY_HEIGHT_PX * PADDING_FACTOR * FONT_BOOST) + PADDING : 0;
                
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "Area" ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ö "Operations report" ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Operation Report ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                currentY = Math.max(currentY + LINE_HEIGHT_TITLE, topPadding + employeeBlockHeight);


                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏±‡∏î‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                targetCtx.textAlign = 'left'; 
                const leftX = leftPadding; 

                // --- 2. Area (NORMAL FONT) ---
                targetCtx.font = `bold ${FONT_SIZE_OTHER_PX}px Inter, sans-serif`;
                targetCtx.fillText(`Area : ${area}`, leftX, currentY); 
                currentY += LINE_HEIGHT_OTHER; 
                
                // --- 3. Title job (NORMAL FONT) ---
                targetCtx.font = `bold ${FONT_SIZE_OTHER_PX}px Inter, sans-serif`;
                targetCtx.fillText(`Title job : ${titleJop}`, leftX, currentY); 
                currentY += LINE_HEIGHT_OTHER; 
                
                // --- 4. SAP No. (NORMAL FONT) ---
                targetCtx.font = `bold ${FONT_SIZE_OTHER_PX}px Inter, sans-serif`;
                targetCtx.fillText(`SAP : ${sapNo}`, leftX, currentY); 
                currentY += LINE_HEIGHT_OTHER; 
                
                // --- 5. Date (‡πÉ‡∏ï‡πâ SAP No. ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ - NORMAL FONT) ---
                targetCtx.font = `bold ${FONT_SIZE_OTHER_PX}px Inter, sans-serif`;
                targetCtx.fillText(`Date: ${dateValue}`, leftX, currentY); 
                currentY += LINE_HEIGHT_OTHER; 

                
                // Clear shadow settings
                targetCtx.shadowColor = 'transparent';
                targetCtx.shadowBlur = 0;
                targetCtx.shadowOffsetX = 0;
                targetCtx.shadowOffsetY = 0;

                return currentY + PADDING; // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            }

            /**
             * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å input type="file"
             */
            function drawEmployeeImages(targetCtx, W, H) {
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà null ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
                const activeEmployeeImages = loadedEmployeeImages.filter(img => img !== null);
                if (activeEmployeeImages.length === 0) return;

                const PADDING = 10 * PADDING_FACTOR; 
                const FONT_BOOST = PADDING_FACTOR > 1 ? FONT_EXPORT_BOOST_FACTOR : 1; 

                const imgWidth = EMPLOYEE_DISPLAY_WIDTH_PX * PADDING_FACTOR * FONT_BOOST;
                const imgHeight = EMPLOYEE_DISPLAY_HEIGHT_PX * PADDING_FACTOR * FONT_BOOST;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà 'active' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                const totalActiveEmployeeWidth = (imgWidth * activeEmployeeImages.length) + (PADDING * (activeEmployeeImages.length - 1));
                const startX = W - totalActiveEmployeeWidth - PADDING; // ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤
                const startY = PADDING; // ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

                let currentX = startX;

                // *** ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ***
                targetCtx.shadowColor = 'rgba(0, 0, 0, 0.4)'; 
                targetCtx.shadowBlur = 6 * PADDING_FACTOR; 
                targetCtx.shadowOffsetX = 2 * PADDING_FACTOR;
                targetCtx.shadowOffsetY = 2 * PADDING_FACTOR;
                // *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏≤ ***

                activeEmployeeImages.forEach(img => {
                    targetCtx.drawImage(img, currentX, startY, imgWidth, imgHeight);
                    currentX += imgWidth + PADDING;
                });

                // *** ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏≤‡∏≠‡∏≠‡∏Å (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) ***
                targetCtx.shadowColor = 'transparent';
                targetCtx.shadowBlur = 0;
                targetCtx.shadowOffsetX = 0;
                targetCtx.shadowOffsetY = 0;
                // *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏≤ ***
            }


            /**
             * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
             * @param {CanvasRenderingContext2D} targetCtx context ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡∏•‡∏á
             * @param {number} W ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Canvas ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Visible ‡∏´‡∏£‡∏∑‡∏≠ Export)
             */
            function drawAllShapes(targetCtx, W) {
                const shapesToDraw = [...shapes, ...(currentShape ? [currentShape] : [])];
                
                const scale = canvas.width > 0 ? W / canvas.width : 1; 

                const FONT_BOOST = PADDING_FACTOR > 1 ? FONT_EXPORT_BOOST_FACTOR : 1; 
                const BASE_FONT_SIZE = TEXT_DRAWING_FONT_SIZE * PADDING_FACTOR * FONT_BOOST;

                shapesToDraw.forEach(shape => {
                    
                    if (shape.type === 'RECT' || shape.type === 'CIRCLE' || shape.type === 'ARROW') {
                        
                        targetCtx.strokeStyle = shape.color;
                        targetCtx.lineWidth = DRAW_LINE_WIDTH_FACTOR * scale; 
                        targetCtx.lineCap = 'round';
                        
                        const x1 = shape.x1 * scale;
                        const y1 = shape.y1 * scale;
                        const x2 = shape.x2 * scale;
                        const y2 = shape.y2 * scale;
                        
                        const w = x2 - x1;
                        const h = y2 - y1;

                        if (shape.type === 'RECT') {
                            targetCtx.strokeRect(x1, y1, w, h);
                        } else if (shape.type === 'CIRCLE') {
                            const dx = x2 - x1;
                            const dy = y2 - y1;
                            const radius = Math.sqrt(dx * dx + dy * dy); 
                            
                            targetCtx.beginPath();
                            targetCtx.arc(x1, y1, radius, 0, Math.PI * 2); 
                            targetCtx.stroke();
                        } else if (shape.type === 'ARROW') {
                            targetCtx.beginPath();
                            targetCtx.moveTo(x1, y1);
                            targetCtx.lineTo(x2, y2);
                            targetCtx.stroke();
                            drawArrowhead(targetCtx, x1, y1, x2, y2);
                        }
                    } else if (shape.type === 'TEXT') {
                        targetCtx.fillStyle = shape.color;
                        targetCtx.textAlign = 'left';
                        targetCtx.textBaseline = 'top'; 
                        targetCtx.font = `bold ${BASE_FONT_SIZE}px Inter, sans-serif`;
                        
                        const x = shape.x * scale;
                        const y = shape.y * scale;

                        targetCtx.fillText(shape.text, x, y);
                    }
                });
            }


            /**
             * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å (Foreground) - ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
             */
            function drawForegroundImages(targetCtx, W, imageAreaStartY, imageAreaH, targetHeight) {
                let totalContentWidth = 0;
                const imageDimensions = []; 
                const PADDING = 10 * PADDING_FACTOR; 

                const EXTERNAL_PADDING = EXTERNAL_H_PADDING_FACTOR * PADDING_FACTOR; 

                loadedImages.forEach(img => {
                    const aspectRatio = img.width / img.height;
                    const scaledWidth = targetHeight * aspectRatio;
                    imageDimensions.push({ width: scaledWidth, height: targetHeight });
                    totalContentWidth += scaledWidth;
                });

                const totalPaddingSpace = loadedImages.length > 0 ? loadedImages.length - 1 : 0;

                const availableBlockWidth = W - (2 * EXTERNAL_PADDING); 

                const maxContentWidth = availableBlockWidth - (totalPaddingSpace * PADDING);

                let scaleFactor = 1;

                if (totalContentWidth > maxContentWidth) {
                    scaleFactor = maxContentWidth / totalContentWidth;
                }

                const finalScaledImagesWidth = totalContentWidth * scaleFactor;
                const totalBlockWidth = finalScaledImagesWidth + (totalPaddingSpace * PADDING);

                const leftoverSpaceInAvailableArea = availableBlockWidth - totalBlockWidth; 
                const startX = EXTERNAL_PADDING + (leftoverSpaceInAvailableArea / 2); 

                let currentX = startX; 

                // *** ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ***
                targetCtx.shadowColor = 'rgba(0, 0, 0, 0.4)'; 
                targetCtx.shadowBlur = 10 * PADDING_FACTOR; 
                targetCtx.shadowOffsetX = 3 * PADDING_FACTOR;
                targetCtx.shadowOffsetY = 3 * PADDING_FACTOR;
                // *** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ***


                imageDimensions.forEach((dim, index
